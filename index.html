<!DOCTYPE html>
<html>
<head>
  <title>Advance Request Form</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input, select {
      margin-bottom: 10px;
      display: block;
      padding: 5px;
    }
  </style>
</head>
<body>
  <h2>Advance Request Form</h2>

  <div id="signinDiv"></div>
  <p id="userEmail"></p>

  <form id="advanceForm">
    <input type="text" name="entity_type" placeholder="Entity Type" required />
    <input type="text" name="advance_against" placeholder="Advance Against" required />
    <input type="text" name="document_no" placeholder="Document No" required />
    <input type="date" name="advance_req_date" required />
    <input type="text" name="advance_req_no" placeholder="Advance Req. No." required />
    <input type="number" name="advance_req_amt" placeholder="Advance Amt." required />
    <input type="text" name="advance_req_party" placeholder="Advance Party" required />
    <input type="text" name="advance_req_party_code" placeholder="Party Code" required />
    <input type="date" name="expected_closure_date" required />
    <input type="number" name="bill_receive_expected_days" placeholder="Bill Expected Days" required />
    
    <label>Attachment (PDF/Image only):</label>
    <input type="file" id="attachment" accept="application/pdf,image/*" required />
    
    <input type="submit" value="Submit" />
  </form>

  <script>
    const allowedEmails = ["samrat.dey@laserpowerinfra.com", "protulchatterjee2020@gmail.com"];
    let userEmail = "";

    function handleCredentialResponse(response) {
      const jwt = parseJwt(response.credential);
      userEmail = jwt.email;
      document.getElementById("userEmail").innerText = "Logged in as: " + userEmail;

      if (!allowedEmails.includes(userEmail.toLowerCase())) {
        alert("You are not authorized to submit this form.");
        document.getElementById("advanceForm").style.display = "none";
        return;
      }
    }

    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
      ).join(''));
      return JSON.parse(jsonPayload);
    }

    window.onload = function () {
      google.accounts.id.initialize({
        client_id: "995677134206-i3n2k43cvsr48ngjb6t69s7tsr0sivpj.apps.googleusercontent.com",
        callback: handleCredentialResponse
      });
      google.accounts.id.renderButton(document.getElementById("signinDiv"), {
        theme: "outline", size: "large"
      });
      google.accounts.id.prompt();
    };

    document.getElementById("advanceForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const form = e.target;
      const fileInput = document.getElementById("attachment");
      const file = fileInput.files[0];

      if (!file) {
        alert("Please attach a file.");
        return;
      }

      const reader = new FileReader();
      reader.onload = async function () {
        const base64Data = reader.result.split(',')[1];
        const formData = new URLSearchParams();

        for (const input of form.elements) {
          if (input.name && input.value)
            formData.append(input.name, input.value);
        }

        formData.append("user_email", userEmail);
        formData.append("attachmentName", file.name);
        formData.append("attachmentType", file.type);
        formData.append("attachmentData", base64Data);

        try {
          const response = await fetch("https://script.google.com/macros/s/AKfycbzzfpXKs2wMrRRtiD52Vx_Xi2lJTZNy0Z2Futvwt2MIGk4JqKhoytEU1Oz6O6EJZVhP/exec", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: formData
          });

          const text = await response.text();
          alert(text.includes("âœ…") ? "Form submitted successfully." : "Error: " + text);
          form.reset();
        } catch (err) {
          console.error(err);
          alert("Failed to submit form.");
        }
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
